<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SSH Honeypot — Database Viewer</title>
  <script src="https://sql.js.org/dist/sql-wasm.js"></script>
  <style>
    :root {
      --bg: #0d1117;
      --surface: #161b22;
      --border: #30363d;
      --text: #c9d1d9;
      --muted: #8b949e;
      --accent: #58a6ff;
      --success: #3fb950;
      --danger: #f85149;
    }
    * { box-sizing: border-box; }
    body {
      font-family: 'JetBrains Mono', 'Fira Code', 'Consolas', monospace;
      background: var(--bg);
      color: var(--text);
      margin: 0;
      padding: 1.5rem;
      min-height: 100vh;
    }
    h1 {
      font-size: 1.25rem;
      font-weight: 600;
      margin: 0 0 1rem;
      color: var(--accent);
    }
    .upload-zone {
      border: 2px dashed var(--border);
      border-radius: 8px;
      padding: 2rem;
      text-align: center;
      margin-bottom: 1.5rem;
      cursor: pointer;
      transition: border-color 0.2s, background 0.2s;
    }
    .upload-zone:hover, .upload-zone.dragover { border-color: var(--accent); background: rgba(88,166,255,0.05); }
    .upload-zone input { display: none; }
    .upload-zone p { margin: 0; color: var(--muted); }
    .tabs {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }
    .tabs button {
      background: var(--surface);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 0.5rem 1rem;
      border-radius: 6px;
      cursor: pointer;
      font-family: inherit;
    }
    .tabs button:hover { border-color: var(--accent); }
    .tabs button.active { background: var(--accent); color: var(--bg); border-color: var(--accent); }
    .filters {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      margin-bottom: 1rem;
      align-items: center;
    }
    .filters label { color: var(--muted); font-size: 0.85rem; }
    .filters input, .filters select {
      background: var(--surface);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 0.4rem 0.6rem;
      border-radius: 4px;
      font-family: inherit;
    }
    .filters input:focus, .filters select:focus {
      outline: none;
      border-color: var(--accent);
    }
    .stats {
      display: flex;
      gap: 1.5rem;
      margin-bottom: 1rem;
      font-size: 0.9rem;
      color: var(--muted);
    }
    .stats span strong { color: var(--success); }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }
    th, td {
      padding: 0.5rem 0.75rem;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }
    th {
      background: var(--surface);
      color: var(--muted);
      font-weight: 500;
      position: sticky;
      top: 0;
    }
    tr:hover td { background: rgba(88,166,255,0.05); }
    .table-wrap {
      overflow-x: auto;
      max-height: 60vh;
      overflow-y: auto;
      border: 1px solid var(--border);
      border-radius: 8px;
    }
    .hidden { display: none !important; }
    .error { color: var(--danger); margin: 1rem 0; }
    .timestamp { font-variant-numeric: tabular-nums; }
    .mono { font-family: inherit; word-break: break-all; }
    .cmd-cell { white-space: pre-wrap; word-break: break-word; max-width: 40rem; }
    .console-tab { display: flex; flex-direction: column; gap: 1rem; }
    .console-session-picker { display: flex; align-items: center; gap: 0.75rem; flex-wrap: wrap; }
    .console-session-picker label { color: var(--muted); font-size: 0.85rem; }
    .console-session-picker select {
      background: var(--surface);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 0.4rem 0.6rem;
      border-radius: 4px;
      font-family: inherit;
      min-width: 16rem;
    }
    .console-wrap {
      background: #0a0e14;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1rem;
      overflow: auto;
      max-height: 65vh;
      font-size: 0.8rem;
      line-height: 1.4;
    }
    .console-block { margin-bottom: 0.5rem; }
    .console-line { color: var(--text); white-space: pre-wrap; word-break: break-word; }
    .console-prompt { color: var(--success); }
    .console-out { color: var(--muted); white-space: pre-wrap; word-break: break-word; margin-top: 0.15rem; }
    .console-out:empty { display: none; }
    .console-session-meta { color: var(--muted); font-size: 0.8rem; margin-bottom: 0.5rem; }
    .upload-zone.loading { pointer-events: none; opacity: 0.9; }
    .upload-zone.loading .upload-ready { display: none; }
    .upload-zone.loading .upload-loading { display: block; }
    .upload-zone .upload-loading { display: none; }
  </style>
</head>
<body>
  <h1>SSH Honeypot — Database Viewer</h1>

  <div id="upload" class="upload-zone loading">
    <input type="file" id="file" accept=".db,.sqlite,.sqlite3">
    <p class="upload-loading">Loading sql.js…</p>
    <p class="upload-ready">Drop <code>honeypot.db</code> here or click to select</p>
  </div>

  <div id="content" class="hidden">
    <div class="tabs">
      <button data-tab="logins" class="active">Logins</button>
      <button data-tab="commands">Commands</button>
      <button data-tab="console">Console</button>
    </div>

    <div class="stats">
      <span>Logins: <strong id="login-count">0</strong></span>
      <span>Commands: <strong id="cmd-count">0</strong></span>
    </div>

    <div id="logins-panel">
      <div class="filters">
        <label>Username <input type="text" id="filter-login-user" placeholder="Filter..."></label>
        <label>IP <input type="text" id="filter-login-ip" placeholder="Filter..."></label>
        <label>Password <input type="text" id="filter-login-pass" placeholder="Filter..."></label>
        <button id="reset-login-filters">Reset</button>
      </div>
      <div class="table-wrap">
        <table>
          <thead><tr><th>ID</th><th>Username</th><th>Password</th><th>Remote IP</th><th>Client Version</th><th>Timestamp</th></tr></thead>
          <tbody id="logins-tbody"></tbody>
        </table>
      </div>
    </div>

    <div id="commands-panel" class="hidden">
      <div class="filters">
        <label>Username <input type="text" id="filter-cmd-user" placeholder="Filter..."></label>
        <label>IP <input type="text" id="filter-cmd-ip" placeholder="Filter..."></label>
        <label>Command <input type="text" id="filter-cmd-text" placeholder="Filter..."></label>
        <button id="reset-cmd-filters">Reset</button>
      </div>
      <div class="table-wrap">
        <table>
          <thead><tr><th>ID</th><th>Username</th><th>Remote IP</th><th>Command</th><th>Timestamp</th></tr></thead>
          <tbody id="commands-tbody"></tbody>
        </table>
      </div>
    </div>

    <div id="console-panel" class="hidden console-tab">
      <div class="console-session-picker">
        <label>Session (IP + user):</label>
        <select id="console-session">
          <option value="">— select —</option>
        </select>
      </div>
      <div class="console-session-meta" id="console-meta"></div>
      <div class="console-wrap" id="console-output"></div>
    </div>
  </div>

  <div id="error" class="error hidden"></div>

  <script>
    let SQL = null;
    let db = null;

    const config = {
      locateFile: file => `https://sql.js.org/dist/${file}`
    };

    initSqlJs(config).then(module => {
      SQL = module;
      const el = document.getElementById('upload');
      el.classList.remove('loading');
    }).catch(err => {
      document.getElementById('error').textContent = 'Failed to load sql.js: ' + err.message;
      document.getElementById('error').classList.remove('hidden');
      document.getElementById('upload').classList.remove('loading');
    });

    const upload = document.getElementById('upload');
    const fileInput = document.getElementById('file');

    upload.addEventListener('click', () => fileInput.click());
    upload.addEventListener('dragover', e => { e.preventDefault(); upload.classList.add('dragover'); });
    upload.addEventListener('dragleave', () => upload.classList.remove('dragover'));
    upload.addEventListener('drop', e => {
      e.preventDefault();
      upload.classList.remove('dragover');
      if (e.dataTransfer.files.length) loadDb(e.dataTransfer.files[0]);
    });
    fileInput.addEventListener('change', () => {
      if (fileInput.files.length) loadDb(fileInput.files[0]);
    });

    function loadDb(file) {
      if (!SQL) {
        document.getElementById('error').textContent = 'SQL.js is still loading. Please wait a moment and try again.';
        document.getElementById('error').classList.remove('hidden');
        return;
      }
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const buf = new Uint8Array(reader.result);
          db = new SQL.Database(buf);
          document.getElementById('upload').classList.add('hidden');
          document.getElementById('content').classList.remove('hidden');
          document.getElementById('error').classList.add('hidden');
          refresh();
        } catch (e) {
          document.getElementById('error').textContent = 'Invalid database: ' + e.message;
          document.getElementById('error').classList.remove('hidden');
        }
      };
      reader.readAsArrayBuffer(file);
    }

    function runQuery(sql, params = []) {
      if (!db) return [];
      const stmt = db.prepare(sql);
      stmt.bind(params);
      const rows = [];
      while (stmt.step()) rows.push(stmt.get());
      stmt.free();
      return rows;
    }

    function formatTs(ts) {
      if (!ts) return ts;
      const n = parseInt(ts, 10);
      if (isNaN(n)) return ts;
      const d = new Date(n * 1000);
      return d.toISOString().replace('T', ' ').slice(0, 19);
    }

    function hasResponseColumn() {
      if (!db) return false;
      const info = runQuery("PRAGMA table_info(Command)");
      return info.some(r => (r[1] || '').toLowerCase() === 'response');
    }

    const HOSTNAME = 'kali';
    function splitBySemicolonOutsideQuotes(s) {
      const result = [];
      let current = '';
      let inSingle = false, inDouble = false;
      for (let i = 0; i < s.length; i++) {
        const c = s[i];
        if (c === "'" && !inDouble) { inSingle = !inSingle; current += c; }
        else if (c === '"' && !inSingle) { inDouble = !inDouble; current += c; }
        else if (c === '\\' && i + 1 < s.length) { current += s[++i]; }
        else if (c === ';' && !inSingle && !inDouble) { result.push(current); current = ''; }
        else current += c;
      }
      result.push(current);
      return result;
    }
    function emulateCommandInJs(line, username) {
      if (!line || !line.trim()) return '';
      const out = [];
      const lines = line.split('\n');
      for (const ln of lines) {
        const segments = splitBySemicolonOutsideQuotes(ln);
        for (let seg of segments) {
          seg = seg.trim();
          if (!seg) continue;
          const parts = seg.split(/\s+/).filter(Boolean);
          if (!parts.length) continue;
          let cmd = parts[0];
          const rest = seg.slice(seg.indexOf(parts[0]) + parts[0].length).trim();
          if (cmd.includes('=') || ['for','do','done','if','then','fi','break','export'].includes(cmd)) continue;
          if (cmd === '/bin/./uname' || cmd.endsWith('uname')) cmd = 'uname';
          const u = username || 'user';
          switch (cmd) {
            case 'exit': case 'cd': case 'chmod': case 'rm': case 'history': case 'sleep': case 'mv': continue;
            case 'ls':
              if (rest.includes('-la') && (seg.includes('/var/run') || seg.includes('var/run')))
                out.push('total 12\ndrwxr-xr-x 12 root root 300 Jan 15 12:34 .\ndrwxr-xr-x 5 root root 4096 Jan 14 10:00 ..\n-rw-r--r-- 1 root root 0 Jan 15 12:00 gcc.pid');
              else if (rest.includes('-la') && seg.includes('/ '))
                out.push('total 64\ndrwxr-xr-x 5 root root 4096 Jan 15 12:00 .\nlrwxrwxrwx 1 root root 7 Jan 14 10:00 bin -> usr/bin\ndrwxr-xr-x 2 root root 4096 Jan 14 10:00 home\ndrwxr-xr-x 2 root root 4096 Jan 14 10:00 root');
              else out.push('id_rsa  id_rsa.pub  configs');
              break;
            case 'whoami': out.push(u); break;
            case 'id': out.push(`uid=1000(${u}) gid=1000(${u}) groups=1000(${u}),27(sudo),999(docker)`); break;
            case 'pwd': out.push(`/home/${u}`); break;
            case 'echo':
              if (seg.includes('UNAME:')) out.push(`UNAME:Linux #1 SMP Debian 5.10.162-1 (2023-01-21) ${HOSTNAME} 5.10.0-21-amd64 x86_64`);
              else if (seg.includes('ARCH:')) out.push('ARCH:x86_64');
              else if (seg.includes('UPTIME:')) out.push('UPTIME:123456');
              else if (seg.includes('CPUS:')) out.push('CPUS:4');
              else if (seg.includes('CPU_MODEL:')) out.push('CPU_MODEL: Intel(R) Core(TM) i5-8400 CPU @ 2.80GHz');
              else if (seg.includes('GPU:')) out.push('GPU: 00:02.0 VGA compatible controller: Intel Corporation HD Graphics 630');
              else if (seg.includes('CAT_HELP:')) out.push('CAT_HELP: Usage: cat [OPTION]... [FILE]... -n number output lines');
              else if (seg.includes('LS_HELP:')) out.push('LS_HELP: Usage: ls [OPTION]... [FILE]... -l use a long listing format');
              else if (seg.includes('LAST:')) out.push('LAST: root pts/0 1.2.3.4 Mon Jan 15 12:34 still logged in');
              break;
            case 'cat':
              if (seg.includes('/dev/null') && seg.includes('>')) break;
              if (seg.includes('/etc/hostname')) out.push(HOSTNAME);
              else if (seg.includes('/etc/passwd')) out.push('root:x:0:0:root:/root:/bin/bash');
              else if (seg.includes('/etc/shadow')) out.push('root:*:19000:0:99999:7:::');
              else if (seg.includes('/proc/cpuinfo')) out.push('model name\t: Intel(R) Core(TM) i5-8400 CPU @ 2.80GHz');
              else if (seg.includes('/proc/version')) out.push('Linux version 5.10.0-21-amd64 (debian-kernel@lists.debian.org) (gcc (Debian 10.2.1-6) 10.2.1 20210110, GNU ld (GNU Binutils for Debian) 2.35.2) #1 SMP Debian 5.10.162-1 (2023-01-21)');
              else if (seg.includes('/proc/uptime')) out.push('123456.78 123455.12');
              else out.push(`bash: ${cmd}: command not found`);
              break;
            case 'nproc': out.push('4'); break;
            case 'grep':
              if (seg.includes('/proc/cpuinfo')) out.push(seg.includes('-c') && seg.includes('processor') ? '4' : 'model name\t: Intel(R) Core(TM) i5-8400 CPU @ 2.80GHz');
              break;
            case 'uname':
              const onlyM = rest.includes('-m') && !rest.includes('-s') && !rest.includes('-v') && !rest.includes('-n') && !rest.includes('-r');
              out.push(onlyM ? 'x86_64' : `Linux #1 SMP Debian 5.10.162-1 (2023-01-21) ${HOSTNAME} 5.10.0-21-amd64 x86_64`);
              break;
            case 'uptime': out.push(' 12:34:56 up 2 days,  3:21,  1 user,  load average: 0.12, 0.08, 0.06'); break;
            case 'hostname': out.push(HOSTNAME); break;
            case 'lscpu': out.push('Model name:            Intel(R) Core(TM) i5-8400 CPU @ 2.80GHz'); break;
            case 'lspci':
              if (seg.includes('grep VGA -c') || (seg.includes('VGA') && seg.includes('-c'))) out.push('1');
              else if (seg.includes('VGA') || seg.includes('3D')) out.push('00:02.0 VGA compatible controller: Intel Corporation HD Graphics 630');
              else out.push('00:00.0 Host bridge: Intel Corporation 8th Gen Core Processor Host Bridge\n00:02.0 VGA compatible controller: Intel Corporation HD Graphics 630');
              break;
            case 'nvidia-smi':
              if (seg.includes('grep . -c') || (seg.includes('Product Name') && seg.includes('-c'))) out.push('1');
              else out.push('==============NVSMI LOG==============\nDriver Version: 535.129.03   CUDA Version: 12.2\n\nAttached GPUs: 1\n\nGPU 00000000:01:00.0\n    Product Name: NVIDIA GeForce GTX 1080\n    Product Brand: GeForce\n    ...');
              break;
            case 'curl': case 'wget':
              if (line.includes('| sh') || line.includes(' sh -s ')) out.push('#!/bin/sh\nexit 0');
              else if (line.includes('http') || line.includes('://')) out.push(line.includes('curl') ? '  % Total    % Received ... 100   123  100   123 ...' : '--2024-01-15 12:34:56--  http://example.com/script.sh\n... saved [1234/1234]');
              else out.push(`bash: ${cmd}: command not found`);
              break;
            case 'good':
              if (line.includes('http') || line.includes('://')) out.push('--2024-01-15 12:34:56--  http://example.com/script.sh\n... saved [1234/1234]');
              else out.push(`bash: ${cmd}: command not found`);
              break;
            case 'ip':
              out.push(line.includes(' route') ? '10.0.0.0/24 dev eth0 proto kernel scope link src 10.0.0.5' : '1: lo: <LOOPBACK,UP> mtu 65536\n2: eth0: <BROADCAST,UP> mtu 1500');
              break;
            case 'ssh':
              if (rest.includes('-V')) out.push('OpenSSH_8.2p1 Debian-4');
              else out.push(`bash: ${cmd}: command not found`);
              break;
            case 'env': out.push(`USER=${u}\nHOME=/home/${u}\nPATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin\nPWD=/home/${u}\nLANG=C.UTF-8`); break;
            case 'which':
              if (seg.includes('apt')) out.push('/usr/bin/apt');
              else { const arg = rest.split(/\s+/)[0]; if (arg && (seg.includes('nproc') || seg.includes('curl') || seg.includes('wget') || seg.includes('grep') || seg.includes('uname'))) out.push('/usr/bin/' + arg); }
              break;
            case 'ping': if (seg.includes('-c')) out.push('1 packets transmitted, 1 received, 0% packet loss'); break;
            case 'ps': out.push('  PID TTY      TIME CMD\n  1 ?     00:00:01 systemd\n  2 ?     00:00:00 kthreadd'); break;
            case 'mount': out.push('sysfs on /sys type sysfs (rw,nosuid,nodev,noexec)\nproc on /proc type proc (rw,nosuid,nodev,noexec)'); break;
            case 'netstat': if (seg.includes('-tulpn') || seg.includes('-tln')) out.push('tcp  0  0 0.0.0.0:22  0.0.0.0:*  LISTEN  1234/sshd'); break;
            case 'ss': if (seg.includes('-tuln') || seg.includes('-tln')) out.push('State  Recv-Q Send-Q Local Address:Port  Peer Address:Port\ntcp   LISTEN 0  128  0.0.0.0:22  0.0.0.0:*'); break;
            case 'systemctl': if (seg.includes('list-units') || seg.includes('running')) out.push('sshd.service  loaded active running OpenSSH daemon'); break;
            case 'time': out.push('0.00user 0.00system 0:00.00elapsed 0%CPU'); break;
            case 'dmidecode': if (seg.includes('processor-version') || seg.includes('-s')) out.push('Intel(R) Core(TM) i5-8400 CPU @ 2.80GHz'); break;
            default:
              if (cmd.startsWith('./') || (cmd === 'sh' && parts.length > 1)) break;
              if (cmd !== 'scp') out.push(`bash: ${cmd}: command not found`);
          }
        }
      }
      return out.join('\n') ? out.join('\n') + '\n' : '';
    }

    function refresh() {
      if (!db) return;

      const loginCount = runQuery('SELECT COUNT(*) FROM Login')[0]?.[0] ?? 0;
      const cmdCount = runQuery('SELECT COUNT(*) FROM Command')[0]?.[0] ?? 0;
      document.getElementById('login-count').textContent = loginCount;
      document.getElementById('cmd-count').textContent = cmdCount;

      renderLogins();
      renderCommands();
      refreshConsoleSessions();
    }

    function refreshConsoleSessions() {
      const sel = document.getElementById('console-session');
      const meta = document.getElementById('console-meta');
      const out = document.getElementById('console-output');
      if (!db || !sel) return;
      const rows = runQuery('SELECT DISTINCT RemoteIP, Username FROM Command ORDER BY RemoteIP, Username');
      sel.innerHTML = '<option value="">— select —</option>' + rows.map((r, i) => {
        const key = (r[0] || '') + '|' + (r[1] || '');
        return `<option value="${escapeHtml(key)}">${escapeHtml(r[0] || '')} (${escapeHtml(r[1] || '')})</option>`;
      }).join('');
      sel.value = '';
      meta.textContent = '';
      out.innerHTML = '';
    }

    function onConsoleSessionChange() {
      const sel = document.getElementById('console-session');
      const meta = document.getElementById('console-meta');
      const out = document.getElementById('console-output');
      const val = sel.value;
      if (!val || !db) { meta.textContent = ''; out.innerHTML = ''; return; }
      const [ip, user] = val.split('|');
      const hasResp = hasResponseColumn();
      const sql = hasResp
        ? 'SELECT CommandID, Username, RemoteIP, Command, Response, Timestamp FROM Command WHERE RemoteIP = ? AND Username = ? ORDER BY CommandID ASC'
        : 'SELECT CommandID, Username, RemoteIP, Command, Timestamp FROM Command WHERE RemoteIP = ? AND Username = ? ORDER BY CommandID ASC';
      const rows = runQuery(sql, [ip, user]);
      const firstTs = rows[0] ? rows[0][hasResp ? 5 : 4] : null;
      const lastTs = rows.length ? rows[rows.length - 1][hasResp ? 5 : 4] : null;
      meta.textContent = rows.length + ' commands' + (firstTs && lastTs ? ' • ' + formatTs(firstTs) + ' — ' + formatTs(lastTs) : '');
      const hostname = 'kali';
      out.innerHTML = rows.map(r => {
        const cmd = (r[3] ?? '').trim();
        const respFromDb = hasResp ? (r[4] ?? '') : '';
        const resp = (respFromDb && respFromDb.trim()) ? respFromDb : emulateCommandInJs(cmd, user || 'user');
        return '<div class="console-block"><div class="console-line"><span class="console-prompt">' + escapeHtml(user || 'user') + '@' + hostname + ':~$ </span>' + escapeHtml(cmd) + '</div>' + (resp ? '<div class="console-out">' + escapeHtml(resp) + '</div>' : '') + '</div>';
      }).join('');
    }

    function getLoginFilters() {
      return {
        user: document.getElementById('filter-login-user').value.trim(),
        ip: document.getElementById('filter-login-ip').value.trim(),
        pass: document.getElementById('filter-login-pass').value.trim()
      };
    }

    function getCmdFilters() {
      return {
        user: document.getElementById('filter-cmd-user').value.trim(),
        ip: document.getElementById('filter-cmd-ip').value.trim(),
        text: document.getElementById('filter-cmd-text').value.trim()
      };
    }

    function renderLogins() {
      const f = getLoginFilters();
      let sql = 'SELECT LoginID, Username, Password, RemoteIP, RemoteVersion, Timestamp FROM Login WHERE 1=1';
      const params = [];
      if (f.user) { params.push('%' + f.user + '%'); sql += ' AND Username LIKE ?'; }
      if (f.ip) { params.push('%' + f.ip + '%'); sql += ' AND RemoteIP LIKE ?'; }
      if (f.pass) { params.push('%' + f.pass + '%'); sql += ' AND Password LIKE ?'; }
      sql += ' ORDER BY Timestamp DESC';

      const rows = runQuery(sql, params);
      const tbody = document.getElementById('logins-tbody');
      tbody.innerHTML = rows.map(r => `
        <tr>
          <td>${r[0]}</td>
          <td class="mono">${escapeHtml(r[1] ?? '')}</td>
          <td class="mono">${escapeHtml(r[2] ?? '')}</td>
          <td class="mono">${escapeHtml(r[3] ?? '')}</td>
          <td class="mono">${escapeHtml(r[4] ?? '')}</td>
          <td class="timestamp">${formatTs(r[5])}</td>
        </tr>
      `).join('');
    }

    function renderCommands() {
      const f = getCmdFilters();
      let sql = 'SELECT CommandID, Username, RemoteIP, Command, Timestamp FROM Command WHERE 1=1';
      const params = [];
      if (f.user) { params.push('%' + f.user + '%'); sql += ' AND Username LIKE ?'; }
      if (f.ip) { params.push('%' + f.ip + '%'); sql += ' AND RemoteIP LIKE ?'; }
      if (f.text) { params.push('%' + f.text + '%'); sql += ' AND Command LIKE ?'; }
      sql += ' ORDER BY Timestamp DESC';

      const rows = runQuery(sql, params);
      const tbody = document.getElementById('commands-tbody');
      tbody.innerHTML = rows.map(r => `
        <tr>
          <td>${r[0]}</td>
          <td class="mono">${escapeHtml(r[1] ?? '')}</td>
          <td class="mono">${escapeHtml(r[2] ?? '')}</td>
          <td class="mono cmd-cell">${escapeHtml(r[3] ?? '')}</td>
          <td class="timestamp">${formatTs(r[4])}</td>
        </tr>
      `).join('');
    }

    function escapeHtml(s) {
      const div = document.createElement('div');
      div.textContent = s;
      return div.innerHTML;
    }

    document.querySelectorAll('.tabs button').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.tabs button').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById('logins-panel').classList.toggle('hidden', btn.dataset.tab !== 'logins');
        document.getElementById('commands-panel').classList.toggle('hidden', btn.dataset.tab !== 'commands');
        document.getElementById('console-panel').classList.toggle('hidden', btn.dataset.tab !== 'console');
        if (btn.dataset.tab === 'console') refreshConsoleSessions();
      });
    });

    ['filter-login-user','filter-login-ip','filter-login-pass'].forEach(id => {
      document.getElementById(id).addEventListener('input', debounce(renderLogins, 250));
    });
    ['filter-cmd-user','filter-cmd-ip','filter-cmd-text'].forEach(id => {
      document.getElementById(id).addEventListener('input', debounce(renderCommands, 250));
    });

    document.getElementById('reset-login-filters').addEventListener('click', () => {
      document.getElementById('filter-login-user').value = '';
      document.getElementById('filter-login-ip').value = '';
      document.getElementById('filter-login-pass').value = '';
      renderLogins();
    });
    document.getElementById('reset-cmd-filters').addEventListener('click', () => {
      document.getElementById('filter-cmd-user').value = '';
      document.getElementById('filter-cmd-ip').value = '';
      document.getElementById('filter-cmd-text').value = '';
      renderCommands();
    });

    document.getElementById('console-session').addEventListener('change', onConsoleSessionChange);

    function debounce(fn, ms) {
      let t;
      return () => { clearTimeout(t); t = setTimeout(fn, ms); };
    }
  </script>
</body>
</html>
